---

- name: Install Graphite Dependencies for Debian
  apt: "name={{ item }} state=present update_cache=yes"
  with_items: graphite_pkgs

- name: Create PIP requirements file 
  copy: src=opt/graphite/requirements.txt dest=/tmp/requirements.txt

- name: Install Graphite from PIP
  pip: requirements=/tmp/requirements.txt
  environment:
    PYTHONPATH: "/opt/graphite/lib:/opt/graphite/webapp"

- name: Configure graphite apache vhost
  template: >
    src=etc/apache/graphite.conf.j2
    dest=/etc/apache2/sites-enabled/{{ graphite_apache_vhost_name }}
    owner=root
    group=root
    mode=0644
  notify:
    - reload apache

- name: Configure Graphite webapp
  template: >
    src=opt/graphite/webapp/graphite/local_settings.py.j2
    dest=/opt/graphite/webapp/graphite/local_settings.py
    mode=0644
  notify:
    - reload apache

- name: Configure graphite.wsgi
  copy: src=opt/graphite/conf/graphite.wsgi dest=/opt/graphite/conf/graphite.wsgi mode=0644
  notify:
    - reload apache

- name: Include carbon-cache
  include: carbon-cache.yml

- name: Get directory permissions
  stat: path=/opt/graphite
  register: permissions

- debug: msg="{{ permissions }}" 

- name: set permissions for /opt/graphite
  file: path=/opt/graphite owner=www-data group=www-data state=directory recurse=yes

- name: Get graphite directory
  stat: path=/opt/graphite
  register: graphite

- name: Setup sqlitedb
  command: /usr/bin/python manage.py syncdb --noinput chdir=/opt/graphite/webapp/graphite 
   creates=/opt/graphite/storage/graphite.db
  register: sqlite_setup

- name: Change permissions of sqlitedb
  file: >
    path=/opt/graphite/storage/graphite.db
    mode=0755
    owner=www-data
    group=www-data

- name: Wait for sqlitedb to be setup
  shell: sleep 3
  when: sqlite_setup.changed

- name: Start apache httpd
  service: name=apache2 state=running enabled=yes
