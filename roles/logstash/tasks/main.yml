---

- name: enable logstash repository
  apt_repository:
    repo: "deb http://packages.elasticsearch.org/logstash/{{ logstash_version }}/debian stable main"
    state: present

- name: add logstash apt key
  apt_key:
    url: http://packages.elasticsearch.org/GPG-KEY-elasticsearch
    state: present

- name: install logstash package
  apt:
    pkg: "{{ item }}"
    state: present
    update_cache: yes
  with_items:
    - logstash
    - logstash-contrib

- name: copying SSL certificate for lumberjack clients
  copy:
    src: files/certs/logstash-forwarder.pem
    dest: /etc/ssl/certs/logstash-forwarder.pem
    owner: root
    group: ssl-cert
    mode: "0644"

- name: copying SSL private key for lumberjack clients
  copy:
    src: files/certs/logstash-forwarder.key
    dest: /etc/ssl/private/logstash-forwarder.key
    owner: root
    group: ssl-cert
    mode: "0644"

- name: logstash permissions workaround
  file: 
    name: /etc/ssl/private
    mode: 0755
    owner: root
    group: ssl-cert

- name: create logstash configuration
  template:
    src: "{{ item }}"
    dest: "/etc/logstash/conf.d/{{ item | basename | replace('.j2', '') }}"
    owner: root
    group: root
    mode: "0644"
  with_fileglob:
    - ../templates/conf.d/*
  notify:
    - restart logstash
